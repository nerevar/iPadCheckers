<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no">
		
		<title>HTML5 iPad Checkers</title>
		
		<script type="text/javascript" src="jquery.min.js"></script>
		<script type="text/javascript">
var canvas = null;
var context = null;
var cb_lastPoints = [];
var CELL_SIZE = 80;
var BOARD_SIZE = CELL_SIZE * 8;
var touching = false;
var images = {};
var diff_coords = {};
var last_coords = {};

var whitePieces;
var blackPieces;

var wSelected = -1;
var bSelected = -1;

var Cell = function(y, x, king) {
	this.y = y;
	this.x = x;
	this.isKing = king;
};
			
window.onload = function(){
	var sources = {
		green: "./img/green.png",
		blue: "./img/blue.png"
	};
	
	loadImages(sources, function(){
		init();
	});
};


function loadImages(sources, callback){
	var loadedImages = 0;
	var numImages = 0;
	for (var src in sources) {
		numImages++;
	}
	for (var src in sources) {
		images[src] = new Image();
		images[src].onload = function(){
			if (++loadedImages >= numImages) {
				callback();
			}
		};
		images[src].src = sources[src];
	}
}

function init() {
	canvas = document.getElementById("canv");

	whitePieces = [
		new Cell(5, 0, false), new Cell(5, 2, false),
		new Cell(5, 4, false), new Cell(5, 6, false),
		new Cell(6, 1, false), new Cell(6, 3, false),
		new Cell(6, 5, false), new Cell(6, 7, false),
		new Cell(7, 0, false), new Cell(7, 2, false),
		new Cell(7, 4, false), new Cell(7, 6, false)];
	blackPieces = [
		new Cell(0, 1, false), new Cell(0, 3, false),
		new Cell(0, 5, false), new Cell(0, 7, false),
		new Cell(1, 0, false), new Cell(1, 2, false),
		new Cell(1, 4, false), new Cell(1, 6, false),
		new Cell(2, 1, false), new Cell(2, 3, false),
		new Cell(2, 5, false), new Cell(2, 7, false)];	
	
	if (canvas.getContext) {
		
		context = canvas.getContext('2d');
		
		canvas.onmousedown = onStart;
		canvas.onmousemove = onMove;
		canvas.onmouseup = onStop;
		
		canvas.ontouchstart = onStart;
		canvas.ontouchend = onStop;
		canvas.ontouchmove = onMove;
		
		refresh();
	}
}

function log(smth) {
	$('#coords .text').html($('#coords .text').html() + ' | ' + smth);
}

function refresh() {
	context.clearRect(0, 0, BOARD_SIZE, BOARD_SIZE);
	drawBoard();
	drawPieces();
}

function drawPieces() {

	for (i in whitePieces) {
		drawPiece(whitePieces[i], (i == wSelected), true);
	}
	for (i in blackPieces) {
		drawPiece(blackPieces[i], (i == bSelected), false);
	}
}

function drawBoard(){
	context.beginPath();
	for (var x = 0.5; x < BOARD_SIZE; x += CELL_SIZE) {
		context.moveTo(x, 0);
		context.lineTo(x, BOARD_SIZE);
	}
	for (var y = 0.5; y < BOARD_SIZE; y += CELL_SIZE) {
		context.moveTo(0, y);
		context.lineTo(BOARD_SIZE, y);
	}	
	context.strokeStyle = "#eee";
	context.stroke();	
}

function drawPiece(cell, selected, white){
	x = cell.x;
	y = cell.y;
	
	px = CELL_SIZE * x;
	py = CELL_SIZE * y;
	
	piece = white ? images.green : images.blue;
	if (selected) {
		// шашку двигаем, значит на поле её не рисуем
	} else {
		// рисуем обычную шашки
		context.drawImage(piece, px , py);
	}
}

function drawPieceXY(cell, selected, white, y, x){
	px = x ? x : 0;
	py = y ? y : 0;
	
	piece = white ? images.green : images.blue;
	context.drawImage(piece, px , py);
}

function onStart(e) {
	if (e.touches) {
		// Touch event
		coords = getCoords(e.touches[0]); // Get info for finger #1
	} else {
		// Mouse event
		coords = getCoords(e);
	}
	last_coords = coords;
	
	diff_coords = {	x : coords.x - Math.floor(coords.x / CELL_SIZE) * CELL_SIZE, 
					y : coords.y - Math.floor(coords.y / CELL_SIZE) * CELL_SIZE};
	diff_board_coords = {	x : Math.floor(coords.x / CELL_SIZE), 
							y : Math.floor(coords.y / CELL_SIZE)};

	// проверка на попадание в шашку
	if (isHitChecker()) {
		
		// получаем выбранную шашку
		for (i in whitePieces) {
			if (whitePieces[i].x == diff_board_coords.x && whitePieces[i].y == diff_board_coords.y) {
				wSelected = i;
			}
		}
		if (wSelected == -1) {
			for (i in blackPieces) {
				if (blackPieces[i].x == diff_board_coords.x && blackPieces[i].y == diff_board_coords.y) {
					bSelected = i;
				}
			}
		}
		
		touching = true;
	}
	
	return false;
}

// Called whenever cursor position changes after drawing has started
function onStop(e) {
	e.preventDefault();
	
	if (touching) {
		touching = false;

		if (wSelected >=0 ) {
			
			new_x = Math.ceil(last_coords.x / CELL_SIZE) - 1;
			if (new_x > 7) new_x = 7;
			if (new_x < 0) new_x = 0;
			
			new_y = Math.ceil(last_coords.y / CELL_SIZE) - 1;
			if (new_y > 7) new_y = 7;
			if (new_y < 0) new_y = 0;
			
			whitePieces[wSelected].x = new_x;
			whitePieces[wSelected].y = new_y;
			wSelected = -1;
			refresh();
		} else if (bSelected >= 0) {
			blackPieces[bSelected].x = Math.ceil(last_coords.x / CELL_SIZE) - 1;
			blackPieces[bSelected].y = Math.ceil(last_coords.y / CELL_SIZE) - 1;
			bSelected = -1;		
			refresh();
		}
	}
	return false;
}


function onMove(e) {
	if (touching) {
		if (e.touches) {
			// Touch Enabled
			coords = getCoords(e.touches[0]); // Get info for finger i
		} else {
			coords = getCoords(e);
		}
		
		last_coords = coords;
		
		checker_coords = {	x : coords.x - diff_coords.x,
							y : coords.y - diff_coords.y};
		
		//$('#coords .x').text('X: ' + coords.x + '     CX: ' + Math.ceil(coords.x / CELL_SIZE));
		//$('#coords .y').text('Y: ' + coords.x + '     CY: ' + Math.ceil(coords.y / CELL_SIZE));

		refresh();
		
		if (wSelected >= 0) {
			drawPieceXY(whitePieces[wSelected], true, true, checker_coords.y, checker_coords.x);
		} else if (bSelected >= 0) {
			drawPieceXY(blackPieces[bSelected], true, false, checker_coords.y, checker_coords.x);
		}
	}

	return false;
}

// Draw a line on the canvas from (s)tart to (e)nd
function drawLine(sX, sY, eX, eY) {
	context.moveTo(sX, sY);
	context.lineTo(eX, eY);
	return { x: eX, y: eY };
}

// Get the coordinates for a mouse or touch event
function getCoords(e) {
	if (e.offsetX) {
		return { x: e.offsetX, y: e.offsetY };
	}
	else if (e.layerX) {
		return { x: e.layerX, y: e.layerY };
	}
	else {
		return { x: e.pageX - canvas.offsetLeft, y: e.pageY - canvas.offsetTop };
	}
}

function isHitChecker() {
	return Math.sqrt(Math.pow(diff_coords.x - (CELL_SIZE / 2), 2) + Math.pow(diff_coords.y - (CELL_SIZE / 2), 2)) <= (CELL_SIZE / 2);
}		
		
		</script>
		<style type="text/css" media="screen">
			body {
				font: 14px Verdana;
			}
			#wrap {
				width: 768px;
				height:
				max-height: 1024px;
				overflow: hidden;
			}
			#canv_wrap {
				border: 1px solid #777;
				width: 640px;
				margin: 64px auto;
			}
		</style>
	</head>	<body>
		<div id="wrap">
			<div id="canv_wrap">
				<canvas id="canv" width="640" height="640"></canvas>
			</div>
			
			<div id="coords">
				<div class="x"></div>
				<div class="y"></div>
				<div class="text"></div>
			</div>			
		</div>
	</body>
</html>